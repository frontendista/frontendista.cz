---
import { graphql } from "@octokit/graphql";

import Link from "~/components/common/link.astro";
import FooterDisclosure, { type Props as IFooterDisclosure } from "./footer-disclosure.astro";

import type { GitHubReleaseResponse } from "~/mocks/github";

export const footer: IFooterDisclosure[] = [
	{
		heading: "Links",
		links: [
			{ name: "Blog", href: "https://blog.frontendista.cz" },
			{ name: "Old blog", href: "https://thesoreon.com" },
			{ name: "Sitemap", href: "/sitemap-index.xml" }
		]
	},
	{
		heading: "Socials",
		links: [
			{ name: "Dev.to", href: "https://dev.to/susickypavel" },
			{ name: "Figma", href: "https://figma.com/@susickypavel" },
			{ name: "GitHub", href: "https://github.com/susickypavel" },
			{ name: "X", href: "https://twitter.com/susickypavel" },
			{ name: "LinkedIn", href: "https://www.linkedin.com/in/susickypavel" }
		]
	},
	{
		heading: "Other",
		links: [
			{ name: "API", href: "https://api.frontendista.cz" },
			{ name: "Bug report", href: "https://github.com/frontendista/frontendista.cz/issues/new/choose" },
			{ name: "Licence", href: "/legal.txt" },
			{ name: "Source code", href: "https://github.com/frontendista/frontendista.cz" }
		]
	}
];

const { repository } = await graphql<GitHubReleaseResponse>({
	headers: {
		authorization: `token ${import.meta.env.GITHUB_PERSONAL_TOKEN}`
	},
	query: `
		query getLatestRelease {
			repository(owner: "frontendista", name: "frontendista.cz") {
				latestRelease {
					tagName
					createdAt
					tagCommit {
						oid
					},
					url
				}
			}
		}
	`
});

const { createdAt, tagCommit, tagName, url } = repository.latestRelease;
---

<footer class="mx-auto max-w-content p-lg pt-0 lg:p-2xl">
	<ul class="flex grid-cols-3 flex-col gap-lg lg:grid">
		{footer.map(section => <FooterDisclosure {...section} />)}
	</ul>
	<p class="mt-lg flex flex-wrap justify-center gap-lg text-center lg:justify-between">
		<Link href={url}>{tagName.split("@")[1]}@{tagCommit.oid.substring(0, 7)} on {new Date(createdAt).toLocaleString("en-US", { month: "long", year: "numeric", day: "numeric" })}</Link>
		<span>2023 &copy; Pavel Sušický. All rights reserved.</span>
	</p>
</footer>

<script>
	const disclosureParent = document.querySelector("footer") as HTMLElement;

	function open() {
		disclosureParent.querySelectorAll("details").forEach(disclosure => {
			disclosure.setAttribute("open", "");
		});
	}

	function close() {
		disclosureParent.querySelectorAll("details").forEach(disclosure => {
			disclosure.removeAttribute("open");
		});
	}

	const MQ = matchMedia("(min-width: 64em");

	if (MQ.matches) {
		open();
	}

	MQ.addEventListener("change", (e) => {
		e.matches ? open() : close();
	});
</script>
